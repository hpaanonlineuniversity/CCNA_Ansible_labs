---
- name: Configure EIGRP on MGRE Tunnel between HQ, YGN and MDY
  hosts: routers
  gather_facts: no
  connection: network_cli

  vars:
    eigrp_config:
      HQ:
        as_number: 100
        network_statements:
          - network 10.10.10.10 0.0.0.0        # MGRE Tunnel Network interface
          - network 192.168.0.1 0.0.0.0       # HQ LAN interface
          
        tunnel_interface: tunnel0
        lan_interface: GigabitEthernet0/2        # LAN side interface
        is_hub: true
        
      YGN:
        as_number: 100
        network_statements:
          - network 10.10.10.11 0.0.0.0        # MGRE Tunnel Network interface
          - network 192.168.1.1 0.0.0.0       # YGN LAN interface
          
        tunnel_interface: tunnel0
        lan_interface: GigabitEthernet0/2        # LAN side interface
        is_hub: false
        
      MDY:
        as_number: 100
        network_statements:
          - network 10.10.10.12 0.0.0.0        # MGRE Tunnel Network interface
          - network 192.168.2.1 0.0.0.0       # MDY LAN interface
          
        tunnel_interface: tunnel0
        lan_interface: GigabitEthernet0/2        # LAN side interface
        is_hub: false

  tasks:
    - name: Configure EIGRP on routers (Internal Networks Only)
      ios_config:
        lines:
          - "router eigrp {{ eigrp_config[inventory_hostname].as_number }}"
          {% for network in eigrp_config[inventory_hostname].network_statements %}
          - "{{ network }}"
          {% endfor %}
          - "no auto-summary"
          - "passive-interface default"
          - "no passive-interface {{ eigrp_config[inventory_hostname].tunnel_interface }}"

    - name: Configure EIGRP on Tunnel interface
      ios_config:
        lines:
          - "interface {{ eigrp_config[inventory_hostname].tunnel_interface }}"
          - "ip bandwidth-percent eigrp {{ eigrp_config[inventory_hostname].as_number }} 50"
          - "ip hello-interval eigrp {{ eigrp_config[inventory_hostname].as_number }} 10"
          - "ip hold-time eigrp {{ eigrp_config[inventory_hostname].as_number }} 30"

    - name: Configure EIGRP stub for spokes (YGN and MDY)
      ios_config:
        lines:
          - "router eigrp {{ eigrp_config[inventory_hostname].as_number }}"
          - "eigrp stub connected summary"
      when: eigrp_config[inventory_hostname].is_hub == false

    - name: Verify EIGRP configuration (Internal Routes Only)
      ios_command:
        commands:
          - show ip protocols
          - show ip eigrp neighbors
          - show ip eigrp topology
          - show ip route eigrp
          - show ip route 192.168.0.0 255.255.0.0 longer-prefixes
      register: eigrp_output

    - name: Display EIGRP status
      debug:
        var: eigrp_output.stdout_lines