---
- name: Complete OSPF Configuration for Cisco Routers
  hosts: routers
  gather_facts: no  
  
  tasks:
    # Task 1: Validate OSPF configuration variables
    - name: Validate OSPF configuration variables
      assert:
        that:
          - router_id is defined
          - ospf_process_id is defined
        fail_msg: "Missing required OSPF variables"

    # Task 2: Configure IP addresses on interfaces
    - name: Configure IP addresses on interfaces
      cisco.ios.ios_l3_interfaces:
        config:
          - name: "{{ item.interface }}"
            ipv4:
              - address: "{{ item.ip_address }}/{{ item.prefix }}"
      loop: "{{ ospf_interfaces }}"
      when: ospf_interfaces is defined

    # Task 2a: No shutdown on GigabitEthernet interfaces
    - name: Enable physical interfaces
      cisco.ios.ios_config:
        lines:
          - "no shutdown"
        parents: "interface {{ item.interface }}"
      loop: "{{ ospf_interfaces | selectattr('interface', 'match', '^GigabitEthernet') | list }}"
      when: ospf_interfaces is defined

    # Task 3: Configure OSPF Process
    - name: Configure OSPF process and router ID
      cisco.ios.ios_ospfv2:
        config:
          processes:
            - process_id: "{{ ospf_process_id }}"
              router_id: "{{ router_id }}"

    # Task 4: Advertise specific interface IPs in OSPF
    - name: Advertise specific interface IPs in OSPF
      cisco.ios.ios_config:
        lines:
          - "network {{ item.network }} {{ item.wildcard }} area {{ item.ospf_area }}"
        parents: "router ospf {{ ospf_process_id }}"
      loop: "{{ ospf_advertised_interfaces }}"
      when: ospf_advertised_interfaces is defined

    # Task 5: Configure OSPF authentication
    - name: Configure OSPF MD5 authentication
      cisco.ios.ios_config:
        lines:
          - "ip ospf message-digest-key {{ ospf_md5_key_id }} md5 {{ ospf_md5_password }}"
          - "ip ospf authentication message-digest"
        parents: "interface {{ item }}"
      loop: "{{ ospf_auth_interfaces }}"
      when: ospf_md5_password is defined

    # Task 6: Configure OSPF passive interfaces
    - name: Configure OSPF passive interfaces
      cisco.ios.ios_config:
        lines:
          - "passive-interface {{ item }}"
        parents: "router ospf {{ ospf_process_id }}"
      loop: "{{ ospf_passive_interfaces }}"
      when: ospf_passive_interfaces is defined