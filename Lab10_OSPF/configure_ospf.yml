---
- name: Complete OSPF Configuration for Cisco Routers
  hosts: routers
  gather_facts: no  
  
  tasks:
    # Task 1: Validate OSPF configuration variables
    - name: Validate OSPF configuration variables
      assert:
        that:
          - router_id is defined
          - ospf_process_id is defined
          - loopback1 is defined
        fail_msg: "Missing required OSPF variables"
    
    # Task 2: Configure Loopback0
    - name: Configure Loopback0
      cisco.ios.ios_config:
        lines:
          - "interface loopback0"
          - "ip address {{ router_id }} 255.255.255.255"
          - "description OSPF Router ID"
          - "exit"
    
    # Task 3: Configure Loopback1
    - name: Configure Loopback1
      cisco.ios.ios_config:
        lines:
          - "interface loopback1"
          - "ip address {{ item.ip_address }} {{ item.mask }}"
          - "description For internal network"
          - "exit"
      loop: "{{ loopback1 }}"
      when: loopback1 is defined    

    # Task 4: Configure IP addresses on interfaces
    - name: Configure IP addresses on interfaces
      cisco.ios.ios_l3_interfaces:
        config:
          - name: "{{ item.interface }}"
            ipv4:
              - address: "{{ item.ip_address }}/{{ item.prefix }}"
      loop: "{{ ospf_interfaces }}"
      when: ospf_interfaces is defined

    # Task 5: No shutdown on GigabitEthernet interfaces
    - name: Enable physical interfaces
      cisco.ios.ios_config:
        lines:
          - "no shutdown"
        parents: "interface {{ item.interface }}"
      loop: "{{ ospf_interfaces | selectattr('interface', 'match', '^GigabitEthernet') | list }}"
      when: ospf_interfaces is defined

    # Task 6: Configure OSPF Process
    - name: Configure OSPF process and router ID
      cisco.ios.ios_ospfv2:
        config:
          processes:
            - process_id: "{{ ospf_process_id }}"
              router_id: "{{ router_id }}"

    # Task 7: Advertise specific interface IPs in OSPF
    - name: Advertise specific interface IPs in OSPF
      cisco.ios.ios_config:
        lines:
          - "network {{ item.network }} {{ item.wildcard }} area {{ item.ospf_area }}"
        parents: "router ospf {{ ospf_process_id }}"
      loop: "{{ ospf_advertised_interfaces }}"
      when: ospf_advertised_interfaces is defined

    # Task 8: Configure OSPF authentication
    - name: Configure OSPF MD5 authentication
      cisco.ios.ios_config:
        lines:
          - "ip ospf message-digest-key {{ ospf_md5_key_id }} md5 {{ ospf_md5_password }}"
          - "ip ospf authentication message-digest"
        parents: "interface {{ item }}"
      loop: "{{ ospf_auth_interfaces }}"
      when: ospf_md5_password is defined

    # Task 9: Configure OSPF passive interfaces
    - name: Configure OSPF passive interfaces
      cisco.ios.ios_command:
        commands:
          - "configure terminal"
          - "router ospf {{ ospf_process_id }}"
          - "passive-interface {{ item }}"
          - "end"
      loop: "{{ ospf_passive_interfaces }}"
      when: ospf_passive_interfaces is defined