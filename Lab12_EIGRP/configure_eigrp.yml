---
- name: Complete EIGRP Configuration for Cisco Routers
  hosts: routers
  gather_facts: no  
  
  tasks:
    # Task 1: Validate EIGRP configuration variables
    - name: Validate EIGRP configuration variables
      assert:
        that:
          - eigrp_autonomous_system is defined
          - eigrp_md5_key is defined
          - eigrp_key_id is defined
        fail_msg: "Missing required EIGRP variables"

    # Task 2: Configure IP addresses on interfaces
    - name: Configure IP addresses on interfaces
      cisco.ios.ios_l3_interfaces:
        config:
          - name: "{{ item.interface }}"
            ipv4:
              - address: "{{ item.ip_address }}/{{ item.prefix }}"
      loop: "{{ eigrp_interfaces }}"
      when: eigrp_interfaces is defined

    # Task 3: No shutdown on GigabitEthernet interfaces
    - name: Enable physical interfaces
      cisco.ios.ios_config:
        lines:
          - "no shutdown"
        parents: "interface {{ item.interface }}"
      loop: "{{ eigrp_interfaces | selectattr('interface', 'match', '^GigabitEthernet') | list }}"
      when: eigrp_interfaces is defined
    
    # Task 4a: Configure EIGRP Basic Settings
    - name: Configure EIGRP Basic Settings
      cisco.ios.ios_config:
        lines:
          - "{{ 'no auto-summary' if eigrp_settings.auto_summary == false else '' }}"
          - "router-id {{ hostname.split('R')[1] }}.{{ hostname.split('R')[1] }}.{{ hostname.split('R')[1] }}.{{ hostname.split('R')[1] }}"
        parents: ["router eigrp {{ eigrp_autonomous_system }}"]
      when: eigrp_advertised_interfaces is defined

    # Task 4b: Configure EIGRP Network Statements
    - name: Configure EIGRP Network Statements
      cisco.ios.ios_config:
        lines:
          - "network {{ item.network }} {{ item.wildcard }}"
        parents: ["router eigrp {{ eigrp_autonomous_system }}"]
      loop: "{{ eigrp_advertised_interfaces }}"
      when: eigrp_advertised_interfaces is defined

    # Task 5: Configure EIGRP MD5 Authentication on specified interfaces
    - name: Configure EIGRP MD5 Authentication
      cisco.ios.ios_config:
        lines:
          - "ip authentication mode eigrp {{ eigrp_autonomous_system }} md5"
          - "ip authentication key-chain eigrp {{ eigrp_autonomous_system }} EIGRP-KEY"
        parents: "interface {{ item }}"
      loop: "{{ eigrp_auth_interfaces }}"
      when: eigrp_auth_interfaces is defined

    # Task 6: Configure complete EIGRP Key Chain
    - name: Configure EIGRP Key Chain
      cisco.ios.ios_config:
        lines:
          - "key chain EIGRP-KEY"
          - "key {{ eigrp_key_id }}"
          - "key-string {{ eigrp_md5_key }}"
        parents: []
        match: none
      when: eigrp_md5_key is defined and eigrp_key_id is defined
   
    # Task 7: Configure EIGRP Passive Interfaces
    - name: Configure EIGRP Passive Interfaces
      cisco.ios.ios_config:
        lines:
          - "passive-interface {{ item.interface }}"
        parents: ["router eigrp {{ eigrp_autonomous_system }}"]
      loop: "{{ eigrp_passive_interfaces }}"
      when: 
        - eigrp_passive_interfaces is defined
        - eigrp_passive_interfaces | length > 0

    # Task 8: Save running configuration to startup
    #- name: Save configuration
    #  cisco.ios.ios_config:
    #    save_when: always
    